<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firestore Data System</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f8f9fa; }
    h1, h2 { color: #0056b3; }
    h1 { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; }
    .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .status { background-color: #e9ecef; padding: 1rem; border-radius: 4px; word-wrap: break-word; }
    .status strong { color: #495057; }
    .loading { color: #6c757d; font-style: italic; }
    button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #6c757d; cursor: not-allowed; }
    input[type="text"] { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; width: calc(100% - 18px); margin-bottom: 1rem; }
  </style>
</head>
<body>

  <h1>Firestore Data Storage System</h1>

  <div class="container">
    <h2>User Authentication</h2>
    <div class="status">
      <strong>User ID:</strong> <span id="user-id-display" class="loading">Authenticating...</span>
    </div>
  </div>

  <div class="container">
    <h2>Public Website Content</h2>
    <p><em>This data is readable by all authenticated users. It is sourced in real-time from <code>/artifacts/{appId}/public/data/website_content</code>.</em></p>
    <div class="status">
      <h3 id="public-title" class="loading">Loading title...</h3>
      <p id="public-description" class="loading">Loading description...</p>
    </div>
  </div>

  <div class="container">
    <h2>Private User Data</h2>
    <p><em>This data is only accessible to the current user. It is sourced in real-time from <code>/artifacts/{appId}/users/{userId}/user_data</code>.</em></p>
    <div class="status">
      <p><strong>Name:</strong> <span id="private-name" class="loading">Loading...</span></p>
      <p><strong>Counter:</strong> <span id="private-counter" class="loading">Loading...</span></p>
    </div>
    <div id="private-data-controls" style="display: none; margin-top: 1rem;">
        <h3>Update Your Private Data</h3>
        <input type="text" id="name-input" placeholder="Enter new name" />
        <button id="update-name-btn">Update Name</button>
        <button id="increment-counter-btn" style="margin-left: 0.5rem;">Increment Counter</button>
    </div>
  </div>

  <script type="module">
    // These global variables must be defined in your environment before this script runs.
    // Example:
    // const __firebase_config = { apiKey: "...", authDomain: "...", ... };
    // const __app_id = "my-awesome-app";
    // const __initial_auth_token = "optional_jwt_token";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // --- 1. INITIALIZATION ---
    if (typeof __firebase_config === 'undefined' || typeof __app_id === 'undefined') {
      document.body.innerHTML = '<h1>Error: Firebase configuration variables are missing.</h1>';
      throw new Error("Missing __firebase_config or __app_id");
    }
    const app = initializeApp(__firebase_config);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userIdDisplay = document.getElementById('user-id-display');
    const privateDataControls = document.getElementById('private-data-controls');

    // --- 2. AUTHENTICATION ---
    onAuthStateChanged(auth, user => {
      if (user) {
        console.log("User signed in with UID:", user.uid);
        userIdDisplay.textContent = user.uid;
        userIdDisplay.classList.remove('loading');
        privateDataControls.style.display = 'block';

        // Once authenticated, set up the real-time data listeners
        setupPublicContentListener();
        setupPrivateDataListener(user.uid);
        setupPrivateDataControls(user.uid);
      } else {
        console.log("User is signed out.");
        userIdDisplay.textContent = 'Signed out. Attempting to sign in...';
      }
    });

    // Sign-in logic: Prefer custom token, fall back to anonymous.
    (async () => {
      try {
        if (typeof __initial_auth_token === 'string' && __initial_auth_token) {
          console.log("Attempting sign-in with custom token...");
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          console.log("Attempting anonymous sign-in...");
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Authentication failed:", error);
        userIdDisplay.textContent = `Authentication Error: ${error.message}`;
        userIdDisplay.classList.remove('loading');
      }
    })();
    
    // --- 3. PUBLIC CONTENT LISTENER ---
    function setupPublicContentListener() {
      const publicContentPath = `/artifacts/${__app_id}/public/data/website_content`;
      const publicContentDocRef = doc(db, publicContentPath);
      
      const titleEl = document.getElementById('public-title');
      const descEl = document.getElementById('public-description');

      onSnapshot(publicContentDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          console.log("Public content updated:", data);
          titleEl.textContent = data.title || 'No title set';
          descEl.textContent = data.description || 'No description set';
          titleEl.classList.remove('loading');
          descEl.classList.remove('loading');
        } else {
          console.log("Public content document does not exist.");
          titleEl.textContent = 'Public content not found.';
          descEl.textContent = 'Ask an administrator to create the public content document.';
          titleEl.classList.remove('loading');
          descEl.classList.remove('loading');
        }
      }, (error) => {
        console.error("Error fetching public content:", error);
        titleEl.textContent = 'Error loading content.';
        descEl.textContent = error.message;
      });
    }

    // --- 4. PRIVATE DATA LISTENER ---
    function setupPrivateDataListener(userId) {
      const privateDataPath = `/artifacts/${__app_id}/users/${userId}/user_data`;
      const privateDataDocRef = doc(db, privateDataPath);
      
      const nameEl = document.getElementById('private-name');
      const counterEl = document.getElementById('private-counter');

      onSnapshot(privateDataDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          console.log("Private data updated:", data);
          nameEl.textContent = data.name || '(not set)';
          counterEl.textContent = data.counter !== undefined ? data.counter : '(not set)';
        } else {
          console.log("Private data document does not exist. Creating it now.");
          // Create the document for the first time with default values.
          setDoc(privateDataDocRef, { name: 'New User', counter: 0 });
          nameEl.textContent = 'New User';
          counterEl.textContent = 0;
        }
        nameEl.classList.remove('loading');
        counterEl.classList.remove('loading');
      }, (error) => {
        console.error("Error fetching private data:", error);
        nameEl.textContent = 'Error loading data.';
        counterEl.textContent = error.message;
      });
    }
    
    // --- 5. PRIVATE DATA CONTROLS ---
    function setupPrivateDataControls(userId) {
        const privateDataPath = `/artifacts/${__app_id}/users/${userId}/user_data`;
        const privateDataDocRef = doc(db, privateDataPath);

        const nameInput = document.getElementById('name-input');
        const updateNameBtn = document.getElementById('update-name-btn');
        const incrementCounterBtn = document.getElementById('increment-counter-btn');

        updateNameBtn.onclick = async () => {
            if (nameInput.value) {
                console.log(`Updating name to: ${nameInput.value}`);
                updateNameBtn.disabled = true;
                try {
                    // setDoc with { merge: true } updates fields without overwriting the whole document.
                    await setDoc(privateDataDocRef, { name: nameInput.value }, { merge: true });
                    nameInput.value = '';
                } catch (error) {
                    console.error("Error updating name:", error);
                    alert("Failed to update name: " + error.message);
                } finally {
                    updateNameBtn.disabled = false;
                }
            }
        };

        incrementCounterBtn.onclick = async () => {
            const currentCounter = parseInt(document.getElementById('private-counter').textContent, 10);
            const newCounter = isNaN(currentCounter) ? 1 : currentCounter + 1;
            console.log(`Incrementing counter to: ${newCounter}`);
            incrementCounterBtn.disabled = true;
            try {
                await setDoc(privateDataDocRef, { counter: newCounter }, { merge: true });
            } catch (error) {
                console.error("Error incrementing counter:", error);
                alert("Failed to increment counter: " + error.message);
            } finally {
                incrementCounterBtn.disabled = false;
            }
        };
    }
  </script>
</body>
</html>
